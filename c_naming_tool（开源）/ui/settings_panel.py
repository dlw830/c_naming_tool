"""
è®¾ç½®é¢æ¿
"""

import json
import os
from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel,
    QGroupBox, QComboBox, QCheckBox, QLineEdit,
    QPushButton, QMessageBox, QScrollArea, QSpinBox
)
from PyQt6.QtCore import Qt, pyqtSignal


class SettingsPanel(QWidget):
    """è®¾ç½®é¢æ¿"""
    
    # è®¾ç½®å˜æ›´ä¿¡å·
    settings_changed = pyqtSignal(dict)
    
    def __init__(self):
        super().__init__()
        self.settings_file = os.path.join('c_naming_tool', 'config', 'app_settings.json')
        self.settings = {}
        self.init_ui()
        self.load_settings()
    
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        # ä¸»å¸ƒå±€
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.setSpacing(0)
        
        # åˆ›å»ºæ»šåŠ¨åŒºåŸŸ
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setFrameShape(QScrollArea.Shape.NoFrame)
        
        # æ»šåŠ¨åŒºåŸŸçš„å†…å®¹éƒ¨ä»¶
        scroll_content = QWidget()
        layout = QVBoxLayout(scroll_content)
        layout.setContentsMargins(32, 32, 32, 32)
        layout.setSpacing(20)
        
        # æ ‡é¢˜
        title = QLabel("âš™ï¸ è®¾ç½®")
        title.setProperty("class", "title")
        layout.addWidget(title)
        
        hint = QLabel("é…ç½®å·¥å…·çš„è¡Œä¸ºå’Œå¤–è§‚")
        hint.setProperty("class", "hint")
        layout.addWidget(hint)
        
        # å‘½åè§„åˆ™é¢„è®¾
        preset_group = QGroupBox("ğŸ“‹ å‘½åè§„åˆ™é¢„è®¾")
        preset_layout = QVBoxLayout(preset_group)
        
        preset_select_layout = QHBoxLayout()
        preset_select_layout.addWidget(QLabel("é€‰æ‹©é¢„è®¾:"))
        self.preset_combo = QComboBox()
        self.preset_combo.addItems([
            'è‡ªå®šä¹‰', 'Linuxå†…æ ¸é£æ ¼', 'Google C++é£æ ¼', 
            'Hungarianå‘½åæ³•', 'åµŒå…¥å¼é€šç”¨'
        ])
        self.preset_combo.currentTextChanged.connect(self.apply_preset)
        preset_select_layout.addWidget(self.preset_combo)
        preset_select_layout.addStretch()
        preset_layout.addLayout(preset_select_layout)
        
        layout.addWidget(preset_group)
        
        # å‘½åè§„åˆ™è®¾ç½®
        naming_group = QGroupBox("ğŸ“ å‘½åè§„åˆ™è¯¦ç»†è®¾ç½®")
        naming_layout = QVBoxLayout(naming_group)
        
        # å˜é‡ç±»å‹å‰ç¼€é…ç½®
        var_prefix_label = QLabel("å˜é‡ç±»å‹å‰ç¼€:")
        var_prefix_label.setProperty("class", "subtitle")
        naming_layout.addWidget(var_prefix_label)
        
        # å…¨å±€å˜é‡å‰ç¼€
        global_prefix_layout = QHBoxLayout()
        global_prefix_layout.addWidget(QLabel("å…¨å±€å˜é‡:"))
        self.global_prefix_edit = QLineEdit()
        self.global_prefix_edit.setPlaceholderText("g_")
        global_prefix_layout.addWidget(self.global_prefix_edit)
        
        self.global_suffix_edit = QLineEdit()
        self.global_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        global_prefix_layout.addWidget(self.global_suffix_edit)
        global_prefix_layout.addStretch()
        naming_layout.addLayout(global_prefix_layout)
        
        # é™æ€å˜é‡å‰ç¼€
        static_prefix_layout = QHBoxLayout()
        static_prefix_layout.addWidget(QLabel("é™æ€å˜é‡:"))
        self.static_prefix_edit = QLineEdit()
        self.static_prefix_edit.setPlaceholderText("s_")
        static_prefix_layout.addWidget(self.static_prefix_edit)
        
        self.static_suffix_edit = QLineEdit()
        self.static_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        static_prefix_layout.addWidget(self.static_suffix_edit)
        static_prefix_layout.addStretch()
        naming_layout.addLayout(static_prefix_layout)
        
        # å±€éƒ¨å˜é‡å‰ç¼€
        local_prefix_layout = QHBoxLayout()
        local_prefix_layout.addWidget(QLabel("å±€éƒ¨å˜é‡:"))
        self.local_prefix_edit = QLineEdit()
        self.local_prefix_edit.setPlaceholderText("l_")
        local_prefix_layout.addWidget(self.local_prefix_edit)
        
        self.local_suffix_edit = QLineEdit()
        self.local_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        local_prefix_layout.addWidget(self.local_suffix_edit)
        local_prefix_layout.addStretch()
        naming_layout.addLayout(local_prefix_layout)
        
        # ç»“æ„ä½“å‰ç¼€
        struct_prefix_layout = QHBoxLayout()
        struct_prefix_layout.addWidget(QLabel("ç»“æ„ä½“:"))
        self.struct_prefix_edit = QLineEdit()
        self.struct_prefix_edit.setPlaceholderText("st_")
        struct_prefix_layout.addWidget(self.struct_prefix_edit)
        
        self.struct_suffix_edit = QLineEdit()
        self.struct_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        struct_prefix_layout.addWidget(self.struct_suffix_edit)
        struct_prefix_layout.addStretch()
        naming_layout.addLayout(struct_prefix_layout)
        
        # è”åˆä½“å‰ç¼€
        union_prefix_layout = QHBoxLayout()
        union_prefix_layout.addWidget(QLabel("è”åˆä½“:"))
        self.union_prefix_edit = QLineEdit()
        self.union_prefix_edit.setPlaceholderText("un_")
        union_prefix_layout.addWidget(self.union_prefix_edit)
        
        self.union_suffix_edit = QLineEdit()
        self.union_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        union_prefix_layout.addWidget(self.union_suffix_edit)
        union_prefix_layout.addStretch()
        naming_layout.addLayout(union_prefix_layout)
        
        # æšä¸¾å‰ç¼€
        enum_prefix_layout = QHBoxLayout()
        enum_prefix_layout.addWidget(QLabel("æšä¸¾:"))
        self.enum_prefix_edit = QLineEdit()
        self.enum_prefix_edit.setPlaceholderText("e_")
        enum_prefix_layout.addWidget(self.enum_prefix_edit)
        
        self.enum_suffix_edit = QLineEdit()
        self.enum_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        enum_prefix_layout.addWidget(self.enum_suffix_edit)
        enum_prefix_layout.addStretch()
        naming_layout.addLayout(enum_prefix_layout)
        
        # æ•°ç»„å‰ç¼€
        array_prefix_layout = QHBoxLayout()
        array_prefix_layout.addWidget(QLabel("æ•°ç»„:"))
        self.array_prefix_edit = QLineEdit()
        self.array_prefix_edit.setPlaceholderText("a_")
        array_prefix_layout.addWidget(self.array_prefix_edit)
        
        self.array_suffix_edit = QLineEdit()
        self.array_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        array_prefix_layout.addWidget(self.array_suffix_edit)
        array_prefix_layout.addStretch()
        naming_layout.addLayout(array_prefix_layout)
        
        # æŒ‡é’ˆå‰ç¼€
        pointer_prefix_layout = QHBoxLayout()
        pointer_prefix_layout.addWidget(QLabel("æŒ‡é’ˆ:"))
        self.pointer_prefix_edit = QLineEdit()
        self.pointer_prefix_edit.setPlaceholderText("p_")
        pointer_prefix_layout.addWidget(self.pointer_prefix_edit)
        
        self.pointer_suffix_edit = QLineEdit()
        self.pointer_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        pointer_prefix_layout.addWidget(self.pointer_suffix_edit)
        pointer_prefix_layout.addStretch()
        naming_layout.addLayout(pointer_prefix_layout)
        
        # å‡½æ•°å‰ç¼€
        function_prefix_layout = QHBoxLayout()
        function_prefix_layout.addWidget(QLabel("å‡½æ•°:"))
        self.function_prefix_edit = QLineEdit()
        self.function_prefix_edit.setPlaceholderText("å‰ç¼€(å¯é€‰)")
        function_prefix_layout.addWidget(self.function_prefix_edit)
        
        self.function_suffix_edit = QLineEdit()
        self.function_suffix_edit.setPlaceholderText("åç¼€(å¯é€‰)")
        function_prefix_layout.addWidget(self.function_suffix_edit)
        function_prefix_layout.addStretch()
        naming_layout.addLayout(function_prefix_layout)
        
        # ç±»å‹å‰ç¼€è®¾ç½®
        type_prefix_label = QLabel("ç±»å‹å‰ç¼€è®¾ç½®:")
        type_prefix_label.setProperty("class", "subtitle")
        naming_layout.addWidget(type_prefix_label)
        
        # uint8_tå‰ç¼€
        uint8_prefix_layout = QHBoxLayout()
        uint8_prefix_layout.addWidget(QLabel("uint8_t:"))
        self.uint8_prefix_edit = QLineEdit()
        self.uint8_prefix_edit.setPlaceholderText("u8_ æˆ– b_ (å¯é€‰)")
        uint8_prefix_layout.addWidget(self.uint8_prefix_edit)
        uint8_prefix_layout.addStretch()
        naming_layout.addLayout(uint8_prefix_layout)
        
        # uint16_tå‰ç¼€
        uint16_prefix_layout = QHBoxLayout()
        uint16_prefix_layout.addWidget(QLabel("uint16_t:"))
        self.uint16_prefix_edit = QLineEdit()
        self.uint16_prefix_edit.setPlaceholderText("u16_ æˆ– w_ (å¯é€‰)")
        uint16_prefix_layout.addWidget(self.uint16_prefix_edit)
        uint16_prefix_layout.addStretch()
        naming_layout.addLayout(uint16_prefix_layout)
        
        # uint32_tå‰ç¼€
        uint32_prefix_layout = QHBoxLayout()
        uint32_prefix_layout.addWidget(QLabel("uint32_t:"))
        self.uint32_prefix_edit = QLineEdit()
        self.uint32_prefix_edit.setPlaceholderText("u32_ æˆ– dw_ (å¯é€‰)")
        uint32_prefix_layout.addWidget(self.uint32_prefix_edit)
        uint32_prefix_layout.addStretch()
        naming_layout.addLayout(uint32_prefix_layout)
        
        # å‘½åé£æ ¼
        style_label = QLabel("å‘½åé£æ ¼è®¾ç½®:")
        style_label.setProperty("class", "subtitle")
        naming_layout.addWidget(style_label)
        
        style_layout = QHBoxLayout()
        style_layout.addWidget(QLabel("å‘½ååˆ†éš”ç¬¦:"))
        self.naming_style_combo = QComboBox()
        self.naming_style_combo.addItems(['ä¸‹åˆ’çº¿ (_)', 'é©¼å³°å‘½å (camelCase)', 'å¸•æ–¯å¡ (PascalCase)'])
        style_layout.addWidget(self.naming_style_combo)
        style_layout.addStretch()
        naming_layout.addLayout(style_layout)
        
        # å¤§å°å†™é£æ ¼
        case_layout = QHBoxLayout()
        case_layout.addWidget(QLabel("å˜é‡åå¤§å°å†™:"))
        self.case_combo = QComboBox()
        self.case_combo.addItems(['å…¨å°å†™', 'å…¨å¤§å†™', 'é¦–å­—æ¯å¤§å†™'])
        case_layout.addWidget(self.case_combo)
        case_layout.addStretch()
        naming_layout.addLayout(case_layout)
        
        # å¸¸é‡å‘½å
        const_case_layout = QHBoxLayout()
        const_case_layout.addWidget(QLabel("å¸¸é‡å‘½å:"))
        self.const_case_combo = QComboBox()
        self.const_case_combo.addItems(['å…¨å¤§å†™+ä¸‹åˆ’çº¿', 'å…¨å°å†™+ä¸‹åˆ’çº¿', 'kå‰ç¼€+é©¼å³°'])
        const_case_layout.addWidget(self.const_case_combo)
        const_case_layout.addStretch()
        naming_layout.addLayout(const_case_layout)
        
        # å®å‘½å
        macro_case_layout = QHBoxLayout()
        macro_case_layout.addWidget(QLabel("å®å‘½å:"))
        self.macro_case_combo = QComboBox()
        self.macro_case_combo.addItems(['å…¨å¤§å†™+ä¸‹åˆ’çº¿', 'å…¨å°å†™+ä¸‹åˆ’çº¿'])
        macro_case_layout.addWidget(self.macro_case_combo)
        macro_case_layout.addStretch()
        naming_layout.addLayout(macro_case_layout)
        
        # å‘½åé€‰é¡¹
        naming_options_label = QLabel("å‘½åé€‰é¡¹:")
        naming_options_label.setProperty("class", "subtitle")
        naming_layout.addWidget(naming_options_label)
        
        self.use_type_prefix_check = QCheckBox("å¯ç”¨æ•°æ®ç±»å‹å‰ç¼€ (Hungariané£æ ¼)")
        naming_layout.addWidget(self.use_type_prefix_check)
        
        self.use_scope_prefix_check = QCheckBox("å¯ç”¨ä½œç”¨åŸŸå‰ç¼€ (g_/s_/l_)")
        self.use_scope_prefix_check.setChecked(True)
        naming_layout.addWidget(self.use_scope_prefix_check)
        
        self.use_module_prefix_check = QCheckBox("å¯ç”¨æ¨¡å—å‰ç¼€")
        naming_layout.addWidget(self.use_module_prefix_check)
        
        # æ¨¡å—å‰ç¼€è®¾ç½®
        module_prefix_layout = QHBoxLayout()
        module_prefix_layout.addWidget(QLabel("  æ¨¡å—å‰ç¼€:"))
        self.module_prefix_edit = QLineEdit()
        self.module_prefix_edit.setPlaceholderText("ä¾‹å¦‚: UART_")
        module_prefix_layout.addWidget(self.module_prefix_edit)
        module_prefix_layout.addStretch()
        naming_layout.addLayout(module_prefix_layout)
        
        layout.addWidget(naming_group)
        
        # ä»£ç ç”Ÿæˆè®¾ç½®
        codegen_group = QGroupBox("ğŸ”§ ä»£ç ç”Ÿæˆ")
        codegen_layout = QVBoxLayout(codegen_group)
        
        # æ³¨é‡Šè¯­è¨€
        comment_lang_layout = QHBoxLayout()
        comment_lang_layout.addWidget(QLabel("æ³¨é‡Šè¯­è¨€:"))
        self.comment_lang_combo = QComboBox()
        self.comment_lang_combo.addItems(['ä¸­æ–‡', 'è‹±æ–‡', 'ä¸­è‹±åŒè¯­'])
        comment_lang_layout.addWidget(self.comment_lang_combo)
        comment_lang_layout.addStretch()
        codegen_layout.addLayout(comment_lang_layout)
        
        # ç¼©è¿›æ–¹å¼
        indent_layout = QHBoxLayout()
        indent_layout.addWidget(QLabel("ç¼©è¿›æ–¹å¼:"))
        self.indent_combo = QComboBox()
        self.indent_combo.addItems(['4ç©ºæ ¼', '2ç©ºæ ¼', 'Tab'])
        indent_layout.addWidget(self.indent_combo)
        indent_layout.addStretch()
        codegen_layout.addLayout(indent_layout)
        
        # ç”Ÿæˆé€‰é¡¹
        self.include_range_check = QCheckBox("åŒ…å«èŒƒå›´æ³¨é‡Š")
        self.include_range_check.setChecked(True)
        codegen_layout.addWidget(self.include_range_check)
        
        self.include_naming_breakdown_check = QCheckBox("åŒ…å«å‘½åè§£ææ³¨é‡Š")
        self.include_naming_breakdown_check.setChecked(True)
        codegen_layout.addWidget(self.include_naming_breakdown_check)
        
        self.include_memory_layout_check = QCheckBox("åŒ…å«å†…å­˜å¸ƒå±€æ³¨é‡Š")
        self.include_memory_layout_check.setChecked(True)
        codegen_layout.addWidget(self.include_memory_layout_check)
        
        self.auto_align_check = QCheckBox("è‡ªåŠ¨å¯¹é½æ³¨é‡Š")
        self.auto_align_check.setChecked(True)
        codegen_layout.addWidget(self.auto_align_check)
        
        layout.addWidget(codegen_group)
        
        # ç•Œé¢è®¾ç½®
        ui_group = QGroupBox("ğŸ¨ ç•Œé¢")
        ui_layout = QVBoxLayout(ui_group)
        
        # ä¸»é¢˜
        theme_layout = QHBoxLayout()
        theme_layout.addWidget(QLabel("ä¸»é¢˜:"))
        self.theme_combo = QComboBox()
        self.theme_combo.addItems(['æµ…è‰²', 'æ·±è‰²', 'è·Ÿéšç³»ç»Ÿ'])
        theme_layout.addWidget(self.theme_combo)
        theme_layout.addStretch()
        ui_layout.addLayout(theme_layout)
        
        # å­—ä½“å¤§å°
        font_size_layout = QHBoxLayout()
        font_size_layout.addWidget(QLabel("å­—ä½“å¤§å°:"))
        self.font_size_spin = QSpinBox()
        self.font_size_spin.setRange(10, 20)
        self.font_size_spin.setValue(13)
        self.font_size_spin.setSuffix(" pt")
        font_size_layout.addWidget(self.font_size_spin)
        font_size_layout.addStretch()
        ui_layout.addLayout(font_size_layout)
        
        # ä»£ç å­—ä½“å¤§å°
        code_font_layout = QHBoxLayout()
        code_font_layout.addWidget(QLabel("ä»£ç å­—ä½“å¤§å°:"))
        self.code_font_spin = QSpinBox()
        self.code_font_spin.setRange(10, 18)
        self.code_font_spin.setValue(12)
        self.code_font_spin.setSuffix(" pt")
        code_font_layout.addWidget(self.code_font_spin)
        code_font_layout.addStretch()
        ui_layout.addLayout(code_font_layout)
        
        # è¯­è¨€
        lang_layout = QHBoxLayout()
        lang_layout.addWidget(QLabel("ç•Œé¢è¯­è¨€:"))
        self.lang_combo = QComboBox()
        self.lang_combo.addItems(['ç®€ä½“ä¸­æ–‡', 'English'])
        lang_layout.addWidget(self.lang_combo)
        lang_layout.addStretch()
        ui_layout.addLayout(lang_layout)
        
        layout.addWidget(ui_group)
        
        # ç¿»è¯‘è®¾ç½®
        translation_group = QGroupBox("ğŸŒ ç¿»è¯‘")
        translation_layout = QVBoxLayout(translation_group)
        
        # ç¿»è¯‘å¼•æ“
        engine_layout = QHBoxLayout()
        engine_layout.addWidget(QLabel("ç¿»è¯‘å¼•æ“:"))
        self.translation_engine_combo = QComboBox()
        self.translation_engine_combo.addItems(['æœ¬åœ°è¯åº“', 'åœ¨çº¿API (å¼€å‘ä¸­)'])
        engine_layout.addWidget(self.translation_engine_combo)
        engine_layout.addStretch()
        translation_layout.addLayout(engine_layout)
        
        # ç¿»è¯‘é€‰é¡¹
        self.auto_translate_check = QCheckBox("è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡è¾“å…¥")
        self.auto_translate_check.setChecked(True)
        translation_layout.addWidget(self.auto_translate_check)
        
        self.show_pinyin_check = QCheckBox("æ˜¾ç¤ºæ‹¼éŸ³æç¤º")
        self.show_pinyin_check.setChecked(True)
        translation_layout.addWidget(self.show_pinyin_check)
        
        layout.addWidget(translation_group)
        
        # é«˜çº§è®¾ç½®
        advanced_group = QGroupBox("ğŸ”¬ é«˜çº§")
        advanced_layout = QVBoxLayout(advanced_group)
        
        # æœ€å¤§æ•°ç»„å¤§å°
        max_array_layout = QHBoxLayout()
        max_array_layout.addWidget(QLabel("æœ€å¤§æ•°ç»„å¤§å°:"))
        self.max_array_spin = QSpinBox()
        self.max_array_spin.setRange(100, 1000000)
        self.max_array_spin.setValue(65535)
        max_array_layout.addWidget(self.max_array_spin)
        max_array_layout.addStretch()
        advanced_layout.addLayout(max_array_layout)
        
        # ç»“æ„ä½“å¯¹é½
        align_layout = QHBoxLayout()
        align_layout.addWidget(QLabel("é»˜è®¤ç»“æ„ä½“å¯¹é½:"))
        self.struct_align_combo = QComboBox()
        self.struct_align_combo.addItems(['1å­—èŠ‚', '4å­—èŠ‚', '8å­—èŠ‚', 'è‡ªç„¶å¯¹é½'])
        align_layout.addWidget(self.struct_align_combo)
        align_layout.addStretch()
        advanced_layout.addLayout(align_layout)
        
        # è°ƒè¯•é€‰é¡¹
        self.debug_mode_check = QCheckBox("å¯ç”¨è°ƒè¯•æ¨¡å¼")
        advanced_layout.addWidget(self.debug_mode_check)
        
        self.auto_save_check = QCheckBox("è‡ªåŠ¨ä¿å­˜è®¾ç½®")
        self.auto_save_check.setChecked(True)
        advanced_layout.addWidget(self.auto_save_check)
        
        layout.addWidget(advanced_group)
        
        # æ“ä½œæŒ‰é’®
        btn_layout = QHBoxLayout()
        
        save_btn = QPushButton("ğŸ’¾ ä¿å­˜è®¾ç½®")
        save_btn.setMinimumHeight(40)
        save_btn.clicked.connect(self.save_settings)
        btn_layout.addWidget(save_btn)
        
        reset_btn = QPushButton("ğŸ”„ æ¢å¤é»˜è®¤")
        reset_btn.clicked.connect(self.reset_to_defaults)
        btn_layout.addWidget(reset_btn)
        
        export_btn = QPushButton("ğŸ“¤ å¯¼å‡ºè®¾ç½®")
        export_btn.clicked.connect(self.export_settings)
        btn_layout.addWidget(export_btn)
        
        import_btn = QPushButton("ğŸ“¥ å¯¼å…¥è®¾ç½®")
        import_btn.clicked.connect(self.import_settings)
        btn_layout.addWidget(import_btn)
        
        layout.addLayout(btn_layout)
        
        layout.addStretch()
        
        # å°†å†…å®¹éƒ¨ä»¶è®¾ç½®åˆ°æ»šåŠ¨åŒºåŸŸ
        scroll_area.setWidget(scroll_content)
        main_layout.addWidget(scroll_area)
    
    def load_settings(self):
        """åŠ è½½è®¾ç½®"""
        try:
            if os.path.exists(self.settings_file):
                with open(self.settings_file, 'r', encoding='utf-8') as f:
                    self.settings = json.load(f)
            else:
                self.settings = self.get_default_settings()
            
            self.apply_settings_to_ui()
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"åŠ è½½è®¾ç½®å¤±è´¥: {str(e)}")
            self.settings = self.get_default_settings()
            self.apply_settings_to_ui()
    
    def get_default_settings(self):
        """è·å–é»˜è®¤è®¾ç½®"""
        return {
            'preset': 'è‡ªå®šä¹‰',
            'naming': {
                'global_prefix': 'g_',
                'global_suffix': '',
                'static_prefix': 's_',
                'static_suffix': '',
                'local_prefix': 'l_',
                'local_suffix': '',
                'struct_prefix': 'st_',
                'struct_suffix': '',
                'union_prefix': 'un_',
                'union_suffix': '',
                'enum_prefix': 'e_',
                'enum_suffix': '',
                'array_prefix': 'a_',
                'array_suffix': '',
                'pointer_prefix': 'p_',
                'pointer_suffix': '',
                'function_prefix': '',
                'function_suffix': '',
                'uint8_prefix': '',
                'uint16_prefix': '',
                'uint32_prefix': '',
                'style': 'ä¸‹åˆ’çº¿ (_)',
                'case': 'å…¨å°å†™',
                'const_case': 'å…¨å¤§å†™+ä¸‹åˆ’çº¿',
                'macro_case': 'å…¨å¤§å†™+ä¸‹åˆ’çº¿',
                'use_type_prefix': False,
                'use_scope_prefix': True,
                'use_module_prefix': False,
                'module_prefix': ''
            },
            'codegen': {
                'comment_lang': 'ä¸­æ–‡',
                'indent': '4ç©ºæ ¼',
                'include_range': True,
                'include_naming': True,
                'include_memory': True,
                'auto_align': True
            },
            'ui': {
                'theme': 'æµ…è‰²',
                'font_size': 13,
                'code_font_size': 12,
                'language': 'ç®€ä½“ä¸­æ–‡'
            },
            'translation': {
                'engine': 'æœ¬åœ°è¯åº“',
                'auto_translate': True,
                'show_pinyin': True
            },
            'advanced': {
                'max_array_size': 65535,
                'struct_align': 'è‡ªç„¶å¯¹é½',
                'debug_mode': False,
                'auto_save': True
            }
        }
    
    def apply_settings_to_ui(self):
        """å°†è®¾ç½®åº”ç”¨åˆ°UIæ§ä»¶"""
        # é¢„è®¾
        preset = self.settings.get('preset', 'è‡ªå®šä¹‰')
        self.preset_combo.setCurrentText(preset)
        
        # å‘½åè§„åˆ™
        naming = self.settings.get('naming', {})
        self.global_prefix_edit.setText(naming.get('global_prefix', 'g_'))
        self.global_suffix_edit.setText(naming.get('global_suffix', ''))
        self.static_prefix_edit.setText(naming.get('static_prefix', 's_'))
        self.static_suffix_edit.setText(naming.get('static_suffix', ''))
        self.local_prefix_edit.setText(naming.get('local_prefix', 'l_'))
        self.local_suffix_edit.setText(naming.get('local_suffix', ''))
        self.struct_prefix_edit.setText(naming.get('struct_prefix', 'st_'))
        self.struct_suffix_edit.setText(naming.get('struct_suffix', ''))
        self.union_prefix_edit.setText(naming.get('union_prefix', 'un_'))
        self.union_suffix_edit.setText(naming.get('union_suffix', ''))
        self.enum_prefix_edit.setText(naming.get('enum_prefix', 'e_'))
        self.enum_suffix_edit.setText(naming.get('enum_suffix', ''))
        self.array_prefix_edit.setText(naming.get('array_prefix', 'a_'))
        self.array_suffix_edit.setText(naming.get('array_suffix', ''))
        self.pointer_prefix_edit.setText(naming.get('pointer_prefix', 'p_'))
        self.pointer_suffix_edit.setText(naming.get('pointer_suffix', ''))
        self.function_prefix_edit.setText(naming.get('function_prefix', ''))
        self.function_suffix_edit.setText(naming.get('function_suffix', ''))
        self.uint8_prefix_edit.setText(naming.get('uint8_prefix', ''))
        self.uint16_prefix_edit.setText(naming.get('uint16_prefix', ''))
        self.uint32_prefix_edit.setText(naming.get('uint32_prefix', ''))
        self.naming_style_combo.setCurrentText(naming.get('style', 'ä¸‹åˆ’çº¿ (_)'))
        self.case_combo.setCurrentText(naming.get('case', 'å…¨å°å†™'))
        self.const_case_combo.setCurrentText(naming.get('const_case', 'å…¨å¤§å†™+ä¸‹åˆ’çº¿'))
        self.macro_case_combo.setCurrentText(naming.get('macro_case', 'å…¨å¤§å†™+ä¸‹åˆ’çº¿'))
        self.use_type_prefix_check.setChecked(naming.get('use_type_prefix', False))
        self.use_scope_prefix_check.setChecked(naming.get('use_scope_prefix', True))
        self.use_module_prefix_check.setChecked(naming.get('use_module_prefix', False))
        self.module_prefix_edit.setText(naming.get('module_prefix', ''))
        
        # ä»£ç ç”Ÿæˆ
        codegen = self.settings.get('codegen', {})
        self.comment_lang_combo.setCurrentText(codegen.get('comment_lang', 'ä¸­æ–‡'))
        self.indent_combo.setCurrentText(codegen.get('indent', '4ç©ºæ ¼'))
        self.include_range_check.setChecked(codegen.get('include_range', True))
        self.include_naming_breakdown_check.setChecked(codegen.get('include_naming', True))
        self.include_memory_layout_check.setChecked(codegen.get('include_memory', True))
        self.auto_align_check.setChecked(codegen.get('auto_align', True))
        
        # ç•Œé¢
        ui = self.settings.get('ui', {})
        self.theme_combo.setCurrentText(ui.get('theme', 'æµ…è‰²'))
        self.font_size_spin.setValue(ui.get('font_size', 13))
        self.code_font_spin.setValue(ui.get('code_font_size', 12))
        self.lang_combo.setCurrentText(ui.get('language', 'ç®€ä½“ä¸­æ–‡'))
        
        # ç¿»è¯‘
        translation = self.settings.get('translation', {})
        self.translation_engine_combo.setCurrentText(translation.get('engine', 'æœ¬åœ°è¯åº“'))
        self.auto_translate_check.setChecked(translation.get('auto_translate', True))
        self.show_pinyin_check.setChecked(translation.get('show_pinyin', True))
        
        # é«˜çº§
        advanced = self.settings.get('advanced', {})
        self.max_array_spin.setValue(advanced.get('max_array_size', 65535))
        self.struct_align_combo.setCurrentText(advanced.get('struct_align', 'è‡ªç„¶å¯¹é½'))
        self.debug_mode_check.setChecked(advanced.get('debug_mode', False))
        self.auto_save_check.setChecked(advanced.get('auto_save', True))
    
    def get_settings_from_ui(self):
        """ä»UIæ§ä»¶è·å–è®¾ç½®"""
        return {
            'preset': self.preset_combo.currentText(),
            'naming': {
                'global_prefix': self.global_prefix_edit.text(),
                'global_suffix': self.global_suffix_edit.text(),
                'static_prefix': self.static_prefix_edit.text(),
                'static_suffix': self.static_suffix_edit.text(),
                'local_prefix': self.local_prefix_edit.text(),
                'local_suffix': self.local_suffix_edit.text(),
                'struct_prefix': self.struct_prefix_edit.text(),
                'struct_suffix': self.struct_suffix_edit.text(),
                'union_prefix': self.union_prefix_edit.text(),
                'union_suffix': self.union_suffix_edit.text(),
                'enum_prefix': self.enum_prefix_edit.text(),
                'enum_suffix': self.enum_suffix_edit.text(),
                'array_prefix': self.array_prefix_edit.text(),
                'array_suffix': self.array_suffix_edit.text(),
                'pointer_prefix': self.pointer_prefix_edit.text(),
                'pointer_suffix': self.pointer_suffix_edit.text(),
                'function_prefix': self.function_prefix_edit.text(),
                'function_suffix': self.function_suffix_edit.text(),
                'uint8_prefix': self.uint8_prefix_edit.text(),
                'uint16_prefix': self.uint16_prefix_edit.text(),
                'uint32_prefix': self.uint32_prefix_edit.text(),
                'style': self.naming_style_combo.currentText(),
                'case': self.case_combo.currentText(),
                'const_case': self.const_case_combo.currentText(),
                'macro_case': self.macro_case_combo.currentText(),
                'use_type_prefix': self.use_type_prefix_check.isChecked(),
                'use_scope_prefix': self.use_scope_prefix_check.isChecked(),
                'use_module_prefix': self.use_module_prefix_check.isChecked(),
                'module_prefix': self.module_prefix_edit.text()
            },
            'codegen': {
                'comment_lang': self.comment_lang_combo.currentText(),
                'indent': self.indent_combo.currentText(),
                'include_range': self.include_range_check.isChecked(),
                'include_naming': self.include_naming_breakdown_check.isChecked(),
                'include_memory': self.include_memory_layout_check.isChecked(),
                'auto_align': self.auto_align_check.isChecked()
            },
            'ui': {
                'theme': self.theme_combo.currentText(),
                'font_size': self.font_size_spin.value(),
                'code_font_size': self.code_font_spin.value(),
                'language': self.lang_combo.currentText()
            },
            'translation': {
                'engine': self.translation_engine_combo.currentText(),
                'auto_translate': self.auto_translate_check.isChecked(),
                'show_pinyin': self.show_pinyin_check.isChecked()
            },
            'advanced': {
                'max_array_size': self.max_array_spin.value(),
                'struct_align': self.struct_align_combo.currentText(),
                'debug_mode': self.debug_mode_check.isChecked(),
                'auto_save': self.auto_save_check.isChecked()
            }
        }
    
    def save_settings(self):
        """ä¿å­˜è®¾ç½®"""
        try:
            self.settings = self.get_settings_from_ui()
            
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            os.makedirs(os.path.dirname(self.settings_file), exist_ok=True)
            
            with open(self.settings_file, 'w', encoding='utf-8') as f:
                json.dump(self.settings, f, ensure_ascii=False, indent=2)
            
            # å‘é€è®¾ç½®å˜æ›´ä¿¡å·
            self.settings_changed.emit(self.settings)
            
            QMessageBox.information(self, "æˆåŠŸ", "è®¾ç½®å·²ä¿å­˜")
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"ä¿å­˜è®¾ç½®å¤±è´¥: {str(e)}")
    
    def reset_to_defaults(self):
        """æ¢å¤é»˜è®¤è®¾ç½®"""
        reply = QMessageBox.question(
            self, "ç¡®è®¤é‡ç½®",
            "ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿå½“å‰è®¾ç½®å°†ä¸¢å¤±ã€‚",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            self.settings = self.get_default_settings()
            self.apply_settings_to_ui()
            self.save_settings()
    
    def export_settings(self):
        """å¯¼å‡ºè®¾ç½®"""
        from PyQt6.QtWidgets import QFileDialog
        
        file_path, _ = QFileDialog.getSaveFileName(
            self, "å¯¼å‡ºè®¾ç½®", "settings.json", "JSONæ–‡ä»¶ (*.json)"
        )
        
        if file_path:
            try:
                current_settings = self.get_settings_from_ui()
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(current_settings, f, ensure_ascii=False, indent=2)
                
                QMessageBox.information(self, "æˆåŠŸ", "è®¾ç½®å·²å¯¼å‡º")
            except Exception as e:
                QMessageBox.warning(self, "é”™è¯¯", f"å¯¼å‡ºå¤±è´¥: {str(e)}")
    
    def import_settings(self):
        """å¯¼å…¥è®¾ç½®"""
        from PyQt6.QtWidgets import QFileDialog
        
        file_path, _ = QFileDialog.getOpenFileName(
            self, "å¯¼å…¥è®¾ç½®", "", "JSONæ–‡ä»¶ (*.json)"
        )
        
        if file_path:
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    imported_settings = json.load(f)
                
                self.settings = imported_settings
                self.apply_settings_to_ui()
                self.save_settings()
                
                QMessageBox.information(self, "æˆåŠŸ", "è®¾ç½®å·²å¯¼å…¥")
            except Exception as e:
                QMessageBox.warning(self, "é”™è¯¯", f"å¯¼å…¥å¤±è´¥: {str(e)}")
    
    def apply_preset(self, preset_name):
        """åº”ç”¨é¢„è®¾å‘½åè§„åˆ™"""
        if preset_name == 'è‡ªå®šä¹‰':
            return
        
        presets = {
            'Linuxå†…æ ¸é£æ ¼': {
                'global_prefix': '',
                'static_prefix': '',
                'local_prefix': '',
                'struct_prefix': '',
                'union_prefix': '',
                'enum_prefix': '',
                'array_prefix': '',
                'pointer_prefix': '',
                'function_prefix': '',
                'style': 'ä¸‹åˆ’çº¿ (_)',
                'case': 'å…¨å°å†™',
                'const_case': 'å…¨å¤§å†™+ä¸‹åˆ’çº¿',
                'macro_case': 'å…¨å¤§å†™+ä¸‹åˆ’çº¿',
                'use_type_prefix': False,
                'use_scope_prefix': False
            },
            'Google C++é£æ ¼': {
                'global_prefix': 'g_',
                'static_prefix': 's_',
                'local_prefix': '',
                'struct_prefix': '',
                'union_prefix': '',
                'enum_prefix': '',
                'array_prefix': '',
                'pointer_prefix': '',
                'function_prefix': '',
                'style': 'ä¸‹åˆ’çº¿ (_)',
                'case': 'å…¨å°å†™',
                'const_case': 'kå‰ç¼€+é©¼å³°',
                'macro_case': 'å…¨å¤§å†™+ä¸‹åˆ’çº¿',
                'use_type_prefix': False,
                'use_scope_prefix': True
            },
            'Hungarianå‘½åæ³•': {
                'global_prefix': 'g_',
                'static_prefix': 's_',
                'local_prefix': '',
                'struct_prefix': 'st',
                'union_prefix': 'un',
                'enum_prefix': 'e',
                'array_prefix': 'a',
                'pointer_prefix': 'p',
                'function_prefix': 'fn',
                'uint8_prefix': 'b',
                'uint16_prefix': 'w',
                'uint32_prefix': 'dw',
                'style': 'é©¼å³°å‘½å (camelCase)',
                'case': 'é¦–å­—æ¯å¤§å†™',
                'const_case': 'kå‰ç¼€+é©¼å³°',
                'macro_case': 'å…¨å¤§å†™+ä¸‹åˆ’çº¿',
                'use_type_prefix': True,
                'use_scope_prefix': True
            },
            'åµŒå…¥å¼é€šç”¨': {
                'global_prefix': 'g_',
                'static_prefix': 's_',
                'local_prefix': 'l_',
                'struct_prefix': 'st_',
                'union_prefix': 'un_',
                'enum_prefix': 'e_',
                'array_prefix': 'a_',
                'pointer_prefix': 'p_',
                'function_prefix': '',
                'style': 'ä¸‹åˆ’çº¿ (_)',
                'case': 'å…¨å°å†™',
                'const_case': 'å…¨å¤§å†™+ä¸‹åˆ’çº¿',
                'macro_case': 'å…¨å¤§å†™+ä¸‹åˆ’çº¿',
                'use_type_prefix': False,
                'use_scope_prefix': True
            }
        }
        
        if preset_name in presets:
            preset_config = presets[preset_name]
            
            # åº”ç”¨é¢„è®¾åˆ°UIæ§ä»¶
            self.global_prefix_edit.setText(preset_config.get('global_prefix', ''))
            self.static_prefix_edit.setText(preset_config.get('static_prefix', ''))
            self.local_prefix_edit.setText(preset_config.get('local_prefix', ''))
            self.struct_prefix_edit.setText(preset_config.get('struct_prefix', ''))
            self.union_prefix_edit.setText(preset_config.get('union_prefix', ''))
            self.enum_prefix_edit.setText(preset_config.get('enum_prefix', ''))
            self.array_prefix_edit.setText(preset_config.get('array_prefix', ''))
            self.pointer_prefix_edit.setText(preset_config.get('pointer_prefix', ''))
            self.function_prefix_edit.setText(preset_config.get('function_prefix', ''))
            self.uint8_prefix_edit.setText(preset_config.get('uint8_prefix', ''))
            self.uint16_prefix_edit.setText(preset_config.get('uint16_prefix', ''))
            self.uint32_prefix_edit.setText(preset_config.get('uint32_prefix', ''))
            self.naming_style_combo.setCurrentText(preset_config.get('style', 'ä¸‹åˆ’çº¿ (_)'))
            self.case_combo.setCurrentText(preset_config.get('case', 'å…¨å°å†™'))
            self.const_case_combo.setCurrentText(preset_config.get('const_case', 'å…¨å¤§å†™+ä¸‹åˆ’çº¿'))
            self.macro_case_combo.setCurrentText(preset_config.get('macro_case', 'å…¨å¤§å†™+ä¸‹åˆ’çº¿'))
            self.use_type_prefix_check.setChecked(preset_config.get('use_type_prefix', False))
            self.use_scope_prefix_check.setChecked(preset_config.get('use_scope_prefix', False))
            
            QMessageBox.information(self, "æç¤º", f"å·²åº”ç”¨ {preset_name} é¢„è®¾")
    
    def get_naming_config(self):
        """è·å–å½“å‰å‘½åé…ç½®ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨"""
        naming = self.settings.get('naming', {})
        return {
            'prefixes': {
                'global': naming.get('global_prefix', 'g_'),
                'static': naming.get('static_prefix', 's_'),
                'local': naming.get('local_prefix', 'l_'),
                'struct': naming.get('struct_prefix', 'st_'),
                'union': naming.get('union_prefix', 'un_'),
                'enum': naming.get('enum_prefix', 'e_'),
                'array': naming.get('array_prefix', 'a_'),
                'pointer': naming.get('pointer_prefix', 'p_'),
                'function': naming.get('function_prefix', ''),
                'uint8': naming.get('uint8_prefix', ''),
                'uint16': naming.get('uint16_prefix', ''),
                'uint32': naming.get('uint32_prefix', '')
            },
            'suffixes': {
                'global': naming.get('global_suffix', ''),
                'static': naming.get('static_suffix', ''),
                'local': naming.get('local_suffix', ''),
                'struct': naming.get('struct_suffix', ''),
                'union': naming.get('union_suffix', ''),
                'enum': naming.get('enum_suffix', ''),
                'array': naming.get('array_suffix', ''),
                'pointer': naming.get('pointer_suffix', ''),
                'function': naming.get('function_suffix', '')
            },
            'style': naming.get('style', 'ä¸‹åˆ’çº¿ (_)'),
            'case': naming.get('case', 'å…¨å°å†™'),
            'const_case': naming.get('const_case', 'å…¨å¤§å†™+ä¸‹åˆ’çº¿'),
            'macro_case': naming.get('macro_case', 'å…¨å¤§å†™+ä¸‹åˆ’çº¿'),
            'use_type_prefix': naming.get('use_type_prefix', False),
            'use_scope_prefix': naming.get('use_scope_prefix', True),
            'use_module_prefix': naming.get('use_module_prefix', False),
            'module_prefix': naming.get('module_prefix', '')
        }
